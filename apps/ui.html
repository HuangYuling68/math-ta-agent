<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathTA-Agent · Agent Chat</title>
  <style>
    :root { --bg:#0b0c0e; --panel:#0f1114; --card:#15171a; --muted:#9aa4af; --text:#e6edf3; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --border:#23262a; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;background:linear-gradient(to bottom, rgba(11,12,14,0.9), rgba(11,12,14,0.5));backdrop-filter:blur(6px);z-index:10;padding:10px 0;border-bottom:1px solid var(--border);}
    h1{font-size:18px;margin:0 0 4px}
    .muted{color:var(--muted)}
    .tag{display:inline-block;font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin-left:8px;color:var(--muted)}
    .ok{background:rgba(34,197,94,.15);color:var(--ok);border-color:rgba(34,197,94,.35)}
    .bad{background:rgba(239,68,68,.15);color:var(--bad);border-color:rgba(239,68,68,.35)}
    .chat{display:flex;flex-direction:column;gap:14px;margin:12px 0 96px}
    .msg{display:flex;gap:12px}
    .bubble{max-width:78%;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--card);white-space:pre-wrap;word-wrap:break-word}
    .user .bubble{background:#1d2530}
    details{background:#0f1114;border:1px solid var(--border);border-radius:10px;padding:8px 10px;margin-top:10px}
    summary{cursor:pointer}
    .footer{position:fixed;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--border)}
    .inputbar{max-width:920px;margin:0 auto;padding:10px;display:grid;grid-template-columns:1fr auto;gap:10px}
    textarea{width:100%;min-height:56px;max-height:160px;resize:vertical;background:#0f1114;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    button{background:var(--accent);border:0;border-radius:12px;color:#fff;padding:10px 16px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .toolbar{max-width:920px;margin:0 auto;padding:6px 10px 8px;display:flex;justify-content:space-between;align-items:center}
    .switch{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted)}
    .opt{display:flex;gap:8px;align-items:center}
    .small{font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .btn{background:#2a2f36;border:1px solid var(--border);color:#c9d1d9;border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    code{background:#0f1114;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  </style>
  <!-- MathJax 渲染 LaTeX（行内 $...$，行间 $$...$$） -->
  <script>
    window.MathJax = {
      tex: { inlineMath:[['$', '$'], ['\\(', '\\)']], displayMath:[['$$','$$'], ['\\[','\\]']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <h1>MathTA-Agent · Agent Chat</h1>
        <span id="modeTag" class="tag">checking…</span>
      </div>
      <div class="muted small">像 ChatGPT 一样的窗口：输入问题 → 后端由 LLM 拆解任务并按需调用 SymPy 工具。Enter 发送，Shift+Enter 换行。</div>
    </div>
  </header>

  <main class="wrap">
    <div id="chat" class="chat"></div>
  </main>

  <div class="footer">
    <div class="toolbar">
      <label class="switch"><input id="showSteps" type="checkbox" checked /> 显示工具轨迹</label>
      <div class="row">
        <button class="btn" id="clearBtn">清空</button>
      </div>
    </div>
    <div class="inputbar">
      <textarea id="input" placeholder="例如：differentiate sin(x)*x^2 w.r.t x"></textarea>
      <button id="send">发送</button>
    </div>
  </div>

<script>
const API_SOLVE = "/solve";
const API_HEALTH = "/health";
const chat = document.getElementById('chat');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const showStepsEl = document.getElementById('showSteps');
const clearBtn = document.getElementById('clearBtn');
const modeTag = document.getElementById('modeTag');
const storeKey = "mathTA_agent_chat_v1";

function escapeHtml(s){
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function bubble(role, html, badge){
  const row = document.createElement('div');
  row.className = 'msg ' + role;
  const box = document.createElement('div');
  box.className = 'bubble';
  if (badge) {
    const span = document.createElement('span');
    span.className = 'tag ' + (badge === 'ok' ? 'ok' : 'bad');
    span.textContent = badge === 'ok' ? 'verified' : 'not verified';
    box.appendChild(span);
    box.appendChild(document.createTextNode(' '));
  }
  const body = document.createElement('div');
  body.innerHTML = html;
  box.appendChild(body);
  row.appendChild(box);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
  if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([box]);
}
function stepsDetails(steps, sympyResult){
  if(!steps || !steps.length) return "";
  const items = steps.map(s => `<li><b>[${s.id}] ${escapeHtml(s.action)}</b> — ${escapeHtml(s.detail)}</li>`).join("");
  const sym = sympyResult ? `<details><summary>SymPy 原始结果</summary><pre>${escapeHtml(JSON.stringify(sympyResult, null, 2))}</pre></details>` : "";
  return `<details open><summary>工具轨迹（${steps.length} 步）</summary><ol>${items}</ol></details>${sym}`;
}
function saveHistory(){ localStorage.setItem(storeKey, chat.innerHTML); }
function loadHistory(){ const html = localStorage.getItem(storeKey); if(html){ chat.innerHTML = html; } }

async function send(){
  const q = input.value.trim();
  if(!q) return;
  input.value = "";
  sendBtn.disabled = true;

  // 用户气泡
  bubble('user', escapeHtml(q));

  try{
    const res = await fetch(API_SOLVE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ question: q })
    });
    const data = await res.json();
    if(!res.ok) throw new Error(data?.detail || res.statusText);

    const badge = data.verified ? 'ok' : 'bad';
    const answer = data.explanation || data.final_answer || "";
    let html = `<div><strong>最终答案：</strong></div><div>${answer}</div>`;
    if(showStepsEl.checked){
      html += stepsDetails(data.steps, data.sympy_result);
    }
    bubble('assistant', html, badge);
  }catch(e){
    bubble('assistant', `<span class="tag bad">错误</span> ${escapeHtml(e.message || e)}`);
  }finally{
    saveHistory();
    sendBtn.disabled = false;
  }
}

sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    send();
  }
});
clearBtn.addEventListener('click', ()=>{
  chat.innerHTML = "";
  localStorage.removeItem(storeKey);
  input.focus();
});

// 顶部模式标签
(async function(){
  try{
    const r = await fetch(API_HEALTH);
    const j = await r.json();
    const mode = j.mode || 'unknown';
    modeTag.textContent = mode;
    if(mode.includes('planner')) modeTag.classList.add('ok');
  }catch{
    modeTag.textContent = 'offline';
    modeTag.classList.add('bad');
  }
})();

loadHistory();
</script>
</body>
</html>
